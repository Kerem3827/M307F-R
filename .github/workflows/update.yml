name: Upstream to 4.14.120

on:
  workflow_dispatch:

jobs:
  upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your kernel repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add linux-stable remote
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add stable https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
          git fetch stable

      - name: Cherry-pick from 4.14.113 to 4.14.120
        run: |
          for commit in $(git rev-list --reverse stable/v4.14.113..stable/v4.14.120); do
            echo "🔁 Cherry-picking $commit"
            git cherry-pick $commit || {
              if git diff --quiet; then
                echo "⚠️ Empty commit, skipping $commit"
                git cherry-pick --skip
              else
                echo "🛠 Conflict in $commit, auto-adding & continuing"
                git add .
                git commit -m "🛠 Manual conflict resolution for $commit"
                git cherry-pick --continue || git cherry-pick --abort
              fi
            }
          done

      - name: Push changes
        run: |
          git push origin upstream
